<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Fee Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons (Script moved to end of body) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #006336;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom toast for admin */
        #admin-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateX(20px);
            z-index: 100;
        }
        #admin-toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        #admin-toast.success { background-color: #006336; }
        #admin-toast.error { background-color: #ef4444; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto max-w-6xl p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-[#006336]">Fee Management Admin</h1>
            <div id="auth-status" class="text-sm text-gray-500">Connecting...</div>
        </div>
    </header>

    <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <!-- Left Column: Add Student -->
        <aside class="md:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 sticky top-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Add New Student</h2>
                <form id="add-student-form" class="space-y-4">
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                        <input type="text" id="student-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]">
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Class</label>
                        <input type="text" id="student-class" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]">
                    </div>
                    <div>
                        <label for="roll-number" class="block text-sm font-medium text-gray-700">Roll Number</label>
                        <input type="text" id="roll-number" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]" placeholder="e.g., A-123">
                    </div>
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="tel" id="phone-number" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]">
                    </div>
                    <button type="submit" id="add-student-btn" class="w-full bg-[#006336] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004f2b] transition-colors duration-300 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <span>Add Student</span>
                        <div id="add-student-spinner" class="spinner hidden" style="border-left-color: #fff; width: 20px; height: 20px;"></div>
                    </button>
                </form>
            </div>
        </aside>

        <!-- Right Column: Student List -->
        <main class="md:col-span-2">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Student List</h2>
                <div id="student-list-loader" class="flex justify-center items-center py-8">
                    <div class="spinner"></div>
                    <p class="ml-4 text-gray-600">Loading students...</p>
                </div>
                <div id="student-list" class="space-y-4">
                    <!-- Student items will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Fee Management Modal -->
    <div id="fee-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-3xl mx-auto rounded-xl shadow-lg p-8 transform -translate-y-10">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-semibold">Manage Fees for <span id="modal-student-name" class="text-[#006336]"></span></h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="max-h-[70vh] overflow-y-auto pr-2">
                <!-- Monthly Fees Section -->
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Monthly Fees</h4>
                <div id="monthly-fees-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Monthly fee inputs will be injected here -->
                </div>
                <button id="save-monthly-fees-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center gap-2 mb-6">
                    <span>Save Monthly Fees</span>
                    <div id="save-monthly-spinner" class="spinner hidden" style="border-left-color: #fff; width: 20px; height: 20px;"></div>
                </button>

                <!-- Other Fees Section -->
                <h4 class="text-lg font-semibold text-gray-700 mb-3 pt-4 border-t">Other Fees</h4>
                <div id="other-fees-list" class="space-y-2 mb-4">
                    <!-- Other fee items will be injected here -->
                </div>
                <form id="add-other-fee-form" class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="other-fee-name" placeholder="Fee Name (e.g., Exam Fee)" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]">
                    <input type="number" id="other-fee-amount" placeholder="Amount" class="w-full sm:w-32 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336]">
                    <button type="submit" id="add-other-fee-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 flex items-center justify-center gap-2">
                        <span>Add Fee</span>
                        <div id="add-other-fee-spinner" class="spinner hidden" style="border-left-color: #fff; width: 20px; height: 20px;"></div>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-[60] hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md mx-auto rounded-xl shadow-lg p-8 transform -translate-y-10">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Confirm Deletion</h3>
            <p class="text-gray-600 mb-6" id="delete-modal-text">Are you sure you want to delete this student? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="delete-modal-cancel" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="delete-modal-confirm" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Notification Toast -->
    <div id="admin-toast" class=""></div>

    <!-- Lucide Icons Script -->
    <!-- Moved here from <head> to ensure `lucide` is defined before module script executes -->
    <script src="https://unpkg.com/lucide-icons"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, 
            updateDoc, deleteDoc, query, where, getDocs, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCGZHCC5mIFvO1w936PAmk6dTbEVAHQi5A",
          authDomain: "monthly-fee-payments.firebaseapp.com",
          projectId: "monthly-fee-payments",
          storageBucket: "monthly-fee-payments.firebasestorage.app",
          messagingSenderId: "583176823557",
          appId: "1:583176823557:web:7e7f4eed0bdc27f78f4d6c",
          measurementId: "G-1FW66VC988"
        };
        
        // --- GLOBAL VARIABLES ---
        let db, auth;
        let isAuthReady = false;
        let currentEditingStudentId = null;
        let currentEditingStudentData = null;
        let studentIdToDelete = null; // For delete confirmation
        const months = [
            'January', 'February', 'March', 'April', 'May', 'June', 
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable Firestore logging

                // Auth Handling
                const authStatus = document.getElementById('auth-status');
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        authStatus.textContent = `Signed in (Admin)`;
                        authStatus.classList.add('text-green-600');
                        isAuthReady = true;
                        
                        // Enable the form button
                        document.getElementById('add-student-btn').disabled = false;

                        // Initialize icons *after* auth is ready and script has likely loaded
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        } else {
                            console.warn("Lucide script not yet loaded, trying again in loadStudents.");
                        }

                        loadStudents(); // Load students once authenticated
                    } else {
                        authStatus.textContent = 'Signing in...';
                        authStatus.classList.remove('text-green-600');
                        isAuthReady = false;
                        
                        // Disable the form button
                        document.getElementById('add-student-btn').disabled = true;

                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            authStatus.textContent = 'Connection failed';
                            authStatus.classList.add('text-red-600');
                            showAdminToast("Could not connect to admin service.", "error");
                        });
                    }
                });

                // Form Listeners
                document.getElementById('add-student-form').addEventListener('submit', handleAddStudent);
                document.getElementById('add-other-fee-form').addEventListener('submit', handleAddOtherFee);

                // Modal Listeners
                document.getElementById('modal-close-btn').addEventListener('click', closeModal);
                document.getElementById('fee-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'fee-modal') closeModal();
                });
                document.getElementById('save-monthly-fees-btn').addEventListener('click', handleSaveMonthlyFees);

                // Delete Modal Listeners
                document.getElementById('delete-modal-cancel').addEventListener('click', closeDeleteModal);
                document.getElementById('delete-modal-confirm').addEventListener('click', confirmDeleteStudent);
                document.getElementById('delete-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'delete-modal') closeDeleteModal();
                });

            } catch (e) {
                console.error("Initialization failed:", e);
                showAdminToast("Error loading admin panel.", "error");
            }
        });

        // --- STUDENT MANAGEMENT ---

        /**
         * Handles the "Add Student" form submission.
         */
        async function handleAddStudent(e) {
            e.preventDefault();
            if (!isAuthReady) {
                showAdminToast("Not connected. Please wait.", "error");
                return;
            }

            const name = document.getElementById('student-name').value;
            const sClass = document.getElementById('student-class').value;
            const rollNumber = document.getElementById('roll-number').value.trim().toUpperCase();
            const phone = document.getElementById('phone-number').value;

            if (!name || !sClass || !rollNumber || !phone) {
                showAdminToast("Please fill all fields.", "error");
                return;
            }
            
            toggleButtonLoading('add-student-btn', 'add-student-spinner', true);

            try {
                // Check for duplicate roll number
                const q = query(collection(db, "students"), where("rollNumber", "==", rollNumber));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showAdminToast("A student with this Roll Number already exists.", "error");
                    toggleButtonLoading('add-student-btn', 'add-student-spinner', false);
                    return;
                }

                // Create default fee structures
                const monthlyFees = months.map(month => ({
                    month: month,
                    amount: 0,
                    status: 'Pending'
                }));
                
                const otherFees = []; // Starts empty

                // Add the new student document
                await addDoc(collection(db, "students"), {
                    name,
                    class: sClass,
                    rollNumber,
                    phone,
                    monthlyFees,
                    otherFees,
                    createdAt: new Date()
                });

                showAdminToast("Student added successfully!", "success");
                document.getElementById('add-student-form').reset();

            } catch (error) {
                console.error("Error adding student:", error);
                // This can fail if the composite index for the query is not created.
                // Providing a helpful error message.
                if (error.code === 'failed-precondition') {
                     showAdminToast("Error: Missing database index. Please check Firebase console.", "error", 5000);
                     console.error("Firestore error: The query requires an index. Go to your Firebase console -> Firestore Database -> Indexes and create a composite index for 'students' on 'rollNumber' (Ascending).");
                } else {
                    showAdminToast("Error adding student.", "error");
                }
            } finally {
                toggleButtonLoading('add-student-btn', 'add-student-spinner', false);
            }
        }

        /**
         * Loads and displays the list of students from Firestore.
         */
        function loadStudents() {
            const listContainer = document.getElementById('student-list');
            const loader = document.getElementById('student-list-loader');
            
            const q = query(collection(db, "students"));
            
            onSnapshot(q, (snapshot) => {
                loader.classList.add('hidden');
                listContainer.innerHTML = ''; // Clear list

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">No students found. Add one to get started.</p>';
                    return;
                }
                
                // Sort documents by creation date, newest first
                // This is safer than ordering by 'name' which would require another index
                const docs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeB - timeA; // Newest first
                });

                docs.forEach(doc => {
                    const student = doc.data();
                    const studentEl = document.createElement('div');
                    studentEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border rounded-lg hover:bg-gray-50';
                    studentEl.innerHTML = `
                        <div>
                            <p class="font-semibold text-lg text-gray-900">${student.name}</p>
                            <p class="text-sm text-gray-600">${student.class} | ${student.rollNumber} | ${student.phone}</p>
                        </div>
                        <div class="flex gap-2 mt-4 sm:mt-0">
                            <button class="manage-fees-btn text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                                <i data-lucide="edit" class="w-4 h-4 inline-block -mt-1 mr-1"></i>Manage Fees
                            </button>
                            <button class="delete-student-btn text-sm bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 inline-block -mt-1 mr-1"></i>Delete
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners
                    studentEl.querySelector('.manage-fees-btn').addEventListener('click', () => {
                        openModal(doc.id, student);
                    });
                    studentEl.querySelector('.delete-student-btn').addEventListener('click', () => {
                        showDeleteConfirmation(doc.id, student.name);
                    });

                    listContainer.appendChild(studentEl);
                });
                
                // Re-render icons - this is a good fallback place
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

            }, (error) => {
                console.error("Error loading students:", error);
                loader.classList.add('hidden');
                listContainer.innerHTML = '<p class="text-red-500">Error loading students.</p>';
                showAdminToast("Could not load student list.", "error");
            });
        }

        /**
         * Shows the delete confirmation modal.
         */
        function showDeleteConfirmation(studentId, studentName) {
            studentIdToDelete = studentId;
            document.getElementById('delete-modal-text').textContent = `Are you sure you want to delete ${studentName}? This action cannot be undone.`;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
        }

        /**
         * Closes the delete confirmation modal.
         */
        function closeDeleteModal() {
            studentIdToDelete = null;
            const modal = document.getElementById('delete-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        /**
         * Deletes a student after confirmation.
         */
        async function confirmDeleteStudent() {
            if (!studentIdToDelete) return;

            try {
                await deleteDoc(doc(db, "students", studentIdToDelete));
                showAdminToast("Student deleted successfully.", "success");
            } catch (error) {
                console.error("Error deleting student:", error);
                showAdminToast("Error deleting student.", "error");
            } finally {
                closeDeleteModal();
            }
        }

        // --- FEE MANAGEMENT MODAL ---

        /**
         * Opens and populates the fee management modal.
         */
        function openModal(studentId, student) {
            currentEditingStudentId = studentId;
            currentEditingStudentData = JSON.parse(JSON.stringify(student)); // Deep copy to avoid mutation

            document.getElementById('modal-student-name').textContent = student.name;
            
            // Populate Monthly Fees
            const monthlyContainer = document.getElementById('monthly-fees-container');
            monthlyContainer.innerHTML = '';
            const monthlyFees = student.monthlyFees || [];
            
            months.forEach((month, index) => {
                const fee = monthlyFees.find(f => f.month === month) || { amount: 0, status: 'Pending' };
                const isPaid = fee.status === 'Paid';
                
                monthlyContainer.innerHTML += `
                    <div class="relative">
                        <label for="month-${index}" class="block text-sm font-medium text-gray-700">${month}</label>
                        <input type="number" id="month-${index}" data-month="${month}" 
                               value="${fee.amount}" ${isPaid ? 'disabled' : ''}
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#006336] focus:border-[#006336] ${isPaid ? 'bg-gray-100 text-gray-500' : ''}">
                        ${isPaid ? '<span class="absolute top-7 right-2 text-xs font-bold text-green-600">PAID</span>' : ''}
                    </div>
                `;
            });

            // Populate Other Fees
            renderOtherFees(student.otherFees || []);
            
            // Show modal
            const modal = document.getElementById('fee-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('-translate-y-10');
            }, 10);
            
            // Re-render icons in modal
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Closes the fee management modal.
         */
        function closeModal() {
            currentEditingStudentId = null;
            currentEditingStudentData = null;
            const modal = document.getElementById('fee-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        /**
         * Saves all changes to monthly fees.
         */
        async function handleSaveMonthlyFees() {
            if (!currentEditingStudentId) return;

            toggleButtonLoading('save-monthly-fees-btn', 'save-monthly-spinner', true);
            
            try {
                // Get current status from data to preserve 'Paid' status
                const originalFees = currentEditingStudentData.monthlyFees || [];
                
                const newMonthlyFees = months.map((month, index) => {
                    const input = document.getElementById(`month-${index}`);
                    const originalFee = originalFees.find(f => f.month === month) || { status: 'Pending' };
                    
                    // If fee was already paid, keep original data
                    if (originalFee.status === 'Paid') {
                        return originalFee;
                    }
                    
                    // Otherwise, update with new amount
                    return {
                        month: month,
                        amount: parseInt(input.value) || 0,
                        status: 'Pending' // Will remain pending until paid
                    };
                });
                
                // Update Firestore
                const studentDocRef = doc(db, "students", currentEditingStudentId);
                await updateDoc(studentDocRef, {
                    monthlyFees: newMonthlyFees
                });

                // Update local data
                currentEditingStudentData.monthlyFees = newMonthlyFees;

                showAdminToast("Monthly fees updated successfully!", "success");

            } catch (error) {
                console.error("Error saving monthly fees:", error);
                showAdminToast("Error saving fees.", "error");
            } finally {
                toggleButtonLoading('save-monthly-fees-btn', 'save-monthly-spinner', false);
            }
        }

        /**
         * Handles adding a new "other fee" from the modal form.
         */
        async function handleAddOtherFee(e) {
            e.preventDefault();
            if (!currentEditingStudentId) return;

            const nameInput = document.getElementById('other-fee-name');
            const amountInput = document.getElementById('other-fee-amount');
            const name = nameInput.value.trim();
            const amount = parseInt(amountInput.value);

            if (!name || !amount || amount <= 0) {
                showAdminToast("Please enter a valid fee name and amount.", "error");
                return;
            }

            toggleButtonLoading('add-other-fee-btn', 'add-other-fee-spinner', true);

            try {
                const newFee = { name, amount, status: 'Pending' };
                // Get the most current array from local data
                let updatedOtherFees = [...(currentEditingStudentData.otherFees || [])];
                
                // Check if fee with same name already exists
                if (updatedOtherFees.find(f => f.name.toLowerCase() === name.toLowerCase())) {
                    showAdminToast("A fee with this name already exists.", "error");
                    toggleButtonLoading('add-other-fee-btn', 'add-other-fee-spinner', false);
                    return;
                }

                updatedOtherFees.push(newFee);

                // Update Firestore
                const studentDocRef = doc(db, "students", currentEditingStudentId);
                await updateDoc(studentDocRef, {
                    otherFees: updatedOtherFees
                });

                // Update local data and re-render
                currentEditingStudentData.otherFees = updatedOtherFees;
                renderOtherFees(updatedOtherFees);

                // Clear inputs
                nameInput.value = '';
                amountInput.value = '';
                showAdminToast("Other fee added.", "success");

            } catch (error) {
                console.error("Error adding other fee:", error);
                showAdminToast("Error adding fee.", "error");
            } finally {
                toggleButtonLoading('add-other-fee-btn', 'add-other-fee-spinner', false);
            }
        }

        /**
         * Renders the list of "other fees".
         */
        function renderOtherFees(otherFees) {
            const list = document.getElementById('other-fees-list');
            list.innerHTML = '';
            if (otherFees.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm">No other fees added yet.</p>';
                return;
            }
            
            otherFees.forEach((fee, index) => {
                const isPaid = fee.status === 'Paid';
                list.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-md border">
                        <div>
                            <span class="font-medium">${fee.name}</span> - 
                            <span class="text-gray-700">₹${fee.amount.toLocaleString('en-IN')}</span>
                        </div>
                        ${isPaid ? 
                            '<span class="text-xs font-bold text-green-600 px-2 py-1 bg-green-100 rounded-full">PAID</span>' : 
                            `<button class="delete-other-fee-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>`
                        }
                    </div>
                `;
            });
            
            // Add listeners for delete buttons
            document.querySelectorAll('.delete-other-fee-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    handleDeleteOtherFee(index);
                });
            });

            // Ensure icons render after adding new ones
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Deletes an "other fee" from the list.
         */
        async function handleDeleteOtherFee(index) {
            if (!currentEditingStudentId) return;

            try {
                let updatedOtherFees = [...(currentEditingStudentData.otherFees || [])];
                
                // Check if fee to be deleted is already paid
                if (updatedOtherFees[index].status === 'Paid') {
                    showAdminToast("Cannot delete a fee that has already been paid.", "error");
                    return;
                }
                
                updatedOtherFees.splice(index, 1); // Remove the item

                // Update Firestore
                const studentDocRef = doc(db, "students", currentEditingStudentId);
                await updateDoc(studentDocRef, {
                    otherFees: updatedOtherFees
                });

                // Update local data and re-render
                currentEditingStudentData.otherFees = updatedOtherFees;
                renderOtherFees(updatedOtherFees);

                showAdminToast("Fee deleted successfully.", "success");

            } catch (error) {
                console.error("Error deleting other fee:", error);
                showAdminToast("Error deleting fee.", "error");
            }
        }


        // --- UTILITY FUNCTIONS ---
        
        /**
         * Toggles the loading state of a button.
         */
        function toggleButtonLoading(btnId, spinnerId, isLoading) {
            const btn = document.getElementById(btnId);
            const spinner = document.getElementById(spinnerId);
            if (!btn || !spinner) return;
            
            const btnText = btn.querySelector('span');

            if (isLoading) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                if(btnText) btnText.classList.add('hidden');
            } else {
                btn.disabled = false;
                spinner.classList.add('hidden');
                if(btnText) btnText.classList.remove('hidden');
            }
        }
        
        /**
         * Shows an admin notification toast.
         */
        function showAdminToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('admin-toast');
            if (!toast) return;

            toast.textContent = message;
            toast.className = ``; // Clear classes
            toast.classList.add(type, 'show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

    </script>
</body>
</html>

