<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rafi University Fee Portal</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Lucide Icons for search icon -->
    <script src="https://unpkg.com/lucide-icons"></script>
    <!-- AOS (Animate On Scroll) Library CSS -->
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <style>
        /* Custom styles with the new color palette */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #EDE6DB; /* New off-white background */
            overflow-x: hidden; /* Prevent horizontal scrollbar from AOS animations */
        }
        .status-paid {
            background-color: #dcfce7; /* Tailwind's green-100 */
            color: #166534; /* Tailwind's green-800 */
        }
        .status-pending {
            background-color: #fffbeb; /* Tailwind's yellow-100 */
            color: #b45309; /* Tailwind's yellow-700 */
        }
        .btn-paid {
            background-color: #67B446; /* New light green */
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Custom styles for the notification toast */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            z-index: 100;
        }
        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #toast.success {
            background-color: #006336; /* New dark green */
        }
        #toast.error {
            background-color: #ef4444; /* Tailwind's red-500 */
        }
        /* Spinner styles */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <header class="text-center mb-8 flex flex-col items-center" data-aos="fade-down">
            <!-- ADDED SCHOOL LOGO -->
            <img src="https://i.ibb.co/mCP7MD6m/image-20250927-120756-0000.png" alt="Rafi University Logo" class="h-20 w-20 mb-4 object-contain">
            <h1 class="text-3xl sm:text-4xl font-bold text-[#006336]">Rafi University</h1>
            <p class="text-gray-600 mt-2">Annual Fee Payment Portal</p>
        </header>
        
        <!-- Search Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 border border-gray-200" data-aos="fade-up">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Find Student Details</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="relative flex-grow">
                    <input type="text" id="roll-number-input" placeholder="Enter Roll Number (e.g., A-123)" class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#006336] transition-shadow">
                     <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </span>
                </div>
                <button id="search-btn" class="bg-[#006336] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#004f2b] transition-colors duration-300 flex items-center justify-center gap-2 disabled:bg-gray-400">
                    <span id="search-btn-text">Search</span>
                    <div id="search-spinner" class="spinner hidden"></div>
                </button>
            </div>
            <p id="auth-status" class="text-xs text-gray-500 mt-2">Connecting...</p>
        </div>

        <!-- Student Data Section (Initially Hidden) -->
        <div id="student-data-section" class="hidden">
            <!-- Student Details Card -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 border border-gray-200" data-aos="fade-up" data-aos-delay="100">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Student Information</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Student Name</p>
                        <p id="student-name" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Class</p>
                        <p id="student-class" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Roll Number</p>
                        <p id="student-roll" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                </div>
            </div>

            <!-- Fees Payment Grid -->
            <main data-aos="fade-up" data-aos-delay="200">
                <!-- Monthly Fees -->
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Monthly Fee Payments</h2>
                <div id="monthly-fees-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Monthly fee cards will be dynamically inserted here -->
                </div>

                <!-- Other Fees -->
                <h2 class="text-xl font-semibold text-gray-800 mt-10 mb-4">Other Fees</h2>
                <div id="other-fees-list" class="space-y-4">
                    <!-- Other fee items will be dynamically inserted here -->
                </div>
            </main>
        </div>

        <!-- Footer Section -->
        <footer class="text-center mt-12 py-4" data-aos="fade-up" data-aos-delay="300">
            <div class="flex justify-center items-center gap-8">
                <div class="flex items-center gap-2 text-gray-500">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    <span class="text-sm">SSL Secure</span>
                </div>
                <div class="flex items-center gap-2 text-gray-500">
                    <i data-lucide="shield" class="w-5 h-5"></i>
                    <span class="text-sm">Trusted by Parents</span>
                </div>
            </div>
        </footer>

    </div>
    
    <!-- Notification Toast Element -->
    <div id="toast" class=""></div>

    <!-- Lucide Icons Script -->
    <script src="https://unpkg.com/lucide-icons"></script>
    
    <!-- AOS (Animate On Scroll) Library JS -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, where, getDocs, 
            doc, onSnapshot, updateDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCGZHCC5mIFvO1w936PAmk6dTbEVAHQi5A",
          authDomain: "monthly-fee-payments.firebaseapp.com",
          projectId: "monthly-fee-payments",
          storageBucket: "monthly-fee-payments.firebasestorage.app",
          messagingSenderId: "583176823557",
          appId: "1:583176823557:web:7e7f4eed0bdc27f78f4d6c",
          measurementId: "G-1FW66VC988"
        };
        
        // --- GLOBAL VARIABLES ---
        let db, auth;
        let isAuthReady = false;
        let currentStudentId = null;
        let currentStudentData = null; // To hold all student data
        let unsubscribeStudent = null; // To stop the onSnapshot listener

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize AOS
            AOS.init({
                duration: 800,
                once: true,
                offset: 50,
            });
            
            // Initialize Lucide Icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                
                const authStatus = document.getElementById('auth-status');
                const searchBtn = document.getElementById('search-btn');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        authStatus.textContent = 'Connected. Ready to search.';
                        authStatus.classList.add('text-green-600');
                        searchBtn.disabled = false;
                        isAuthReady = true;
                    } else {
                        authStatus.textContent = 'Connecting...';
                        searchBtn.disabled = true;
                        isAuthReady = false;
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            authStatus.textContent = 'Connection failed. Please refresh.';
                            authStatus.classList.add('text-red-600');
                        });
                    }
                });

            } catch (e) {
                console.error("Firebase init failed:", e);
                showToast("Could not connect to database.", "error");
            }

            document.getElementById('search-btn').addEventListener('click', handleSearch);
            document.getElementById('roll-number-input').addEventListener('keyup', (event) => {
                 if (event.key === 'Enter') {
                    handleSearch();
                }
            });
        });
        
        /**
         * Toggles the loading state of the search button.
         */
        function toggleSearchLoading(isLoading) {
            const btn = document.getElementById('search-btn');
            const spinner = document.getElementById('search-spinner');
            const btnText = document.getElementById('search-btn-text');
            
            if (isLoading) {
                btn.disabled = true;
                spinner.classList.remove('hidden');
                btnText.classList.add('hidden');
            } else {
                btn.disabled = false;
                spinner.classList.add('hidden');
                btnText.classList.remove('hidden');
            }
        }

        /**
         * Handles the search for a student by roll number.
         */
        async function handleSearch() {
            if (!isAuthReady) {
                showToast("Not connected to service. Please wait.", "error");
                return;
            }
            
            const rollInput = document.getElementById('roll-number-input');
            const rollNumber = rollInput.value.trim().toUpperCase();
            
            if (!rollNumber) {
                showToast('Please enter a roll number.', 'error');
                return;
            }
            
            toggleSearchLoading(true);
            
            // Detach previous listener if one exists
            if (unsubscribeStudent) {
                unsubscribeStudent();
                unsubscribeStudent = null;
            }

            const studentDataSection = document.getElementById('student-data-section');
            
            try {
                const q = query(collection(db, "students"), where("rollNumber", "==", rollNumber));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    studentDataSection.classList.add('hidden');
                    showToast('Student not found. Please check the Roll Number.', 'error');
                } else {
                    // Student found, attach a real-time listener
                    const studentDoc = querySnapshot.docs[0];
                    currentStudentId = studentDoc.id;
                    
                    let firstLoad = true; // Flag to show toast only on initial load
                    
                    unsubscribeStudent = onSnapshot(doc(db, "students", currentStudentId), (doc) => {
                        currentStudentData = doc.data(); // Store latest data
                        displayStudentData(currentStudentData);
                        studentDataSection.classList.remove('hidden');
                        
                        if (firstLoad) {
                            showToast(`Displaying details for ${currentStudentData.name}.`, 'success');
                            firstLoad = false;
                        }

                        // Refresh AOS to detect new elements
                        setTimeout(() => AOS.refresh(), 100);
                    });
                    
                    // REMOVED: showToast(`Displaying details for ${currentStudentData.name}.`, 'success');
                }
                
            } catch (error) {
                console.error("Error searching student:", error);
                // Check for a common Firestore error: missing index
                if (error.code === 'failed-precondition') {
                    showToast("Error: Database index is missing. Please contact support.", "error", 5000);
                    console.error("Firestore error: The query requires an index. Go to your Firebase console -> Firestore Database -> Indexes and create a single-field index for 'students' on 'rollNumber' (Ascending).");
                } else {
                    showToast("Error finding student.", "error");
                }
                studentDataSection.classList.add('hidden');
            } finally {
                toggleSearchLoading(false);
            }
        }
        
        /**
         * Populates the UI with student data.
         */
        function displayStudentData(student) {
            document.getElementById('student-name').textContent = student.name;
            document.getElementById('student-class').textContent = student.class;
            document.getElementById('student-roll').textContent = student.rollNumber;
            
            renderMonthlyFeeCards(student.monthlyFees || []);
            renderOtherFeeItems(student.otherFees || []);
        }

        /**
         * Renders monthly fee cards for the student.
         */
        function renderMonthlyFeeCards(fees) {
            const feesGrid = document.getElementById('monthly-fees-grid');
            feesGrid.innerHTML = ''; // Clear existing cards

            if (fees.length === 0) {
                feesGrid.innerHTML = '<p class="text-gray-500">No monthly fees assigned.</p>';
                return;
            }

            fees.forEach((fee, index) => {
                const isPaid = fee.status === 'Paid';
                const statusClass = isPaid ? 'status-paid' : 'status-pending';
                const buttonClass = isPaid ? 'btn-paid' : 'bg-[#006336] hover:bg-[#004f2b]';

                const cardHTML = `
                    <div class="bg-white rounded-xl shadow-md p-5 border border-gray-200 flex flex-col justify-between transition-transform transform hover:scale-105" data-aos="fade-up" data-aos-delay="${index * 50}">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">${fee.month}</h3>
                                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${statusClass}">${fee.status}</span>
                            </div>
                            <p class="text-2xl font-bold text-gray-900">₹${fee.amount.toLocaleString('en-IN')}</p>
                        </div>
                        <button class="w-full text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors duration-300 ${buttonClass}" 
                            ${isPaid ? 'disabled' : ''} onclick="payFee('monthly', '${fee.month}')">
                            ${isPaid ? 'Paid' : 'Pay Now'}
                        </button>
                    </div>`;
                feesGrid.innerHTML += cardHTML;
            });
        }
        
        /**
         * Renders "other fee" items for the student.
         */
        function renderOtherFeeItems(fees) {
            const feesList = document.getElementById('other-fees-list');
            feesList.innerHTML = ''; // Clear existing items

            if (fees.length === 0) {
                feesList.innerHTML = '<p class="text-gray-500">No other fees due at this time.</p>';
                return;
            }
            
            fees.forEach((fee, index) => {
                const isPaid = fee.status === 'Paid';
                const statusClass = isPaid ? 'status-paid' : 'status-pending';
                const buttonClass = isPaid ? 'btn-paid' : 'bg-[#006336] hover:bg-[#004f2b]';
                
                const itemHTML = `
                    <div class="bg-white rounded-xl shadow-md p-5 border border-gray-200 flex flex-col sm:flex-row justify-between sm:items-center gap-4" data-aos="fade-up" data-aos-delay="${index * 50}">
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="text-lg font-semibold text-gray-800">${fee.name}</h3>
                                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${statusClass} sm:hidden">${fee.status}</span>
                            </div>
                            <p class="text-2xl font-bold text-gray-900">₹${fee.amount.toLocaleString('en-IN')}</p>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full sm:w-auto">
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${statusClass} hidden sm:block">${fee.status}</span>
                            <button class="w-full sm:w-auto text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300 ${buttonClass}" 
                                ${isPaid ? 'disabled' : ''} onclick="payFee('other', '${fee.name}')">
                                ${isPaid ? 'Paid' : 'Pay Now'}
                            </button>
                        </div>
                    </div>
                `;
                feesList.innerHTML += itemHTML;
            });
        }
        
        /**
         * Initiates the Razorpay payment process.
         * @param {'monthly' | 'other'} type - The type of fee.
         * @param {string} identifier - The month name or fee name.
         */
        window.payFee = function(type, identifier) {
            let fee;
            if (type === 'monthly') {
                fee = currentStudentData.monthlyFees.find(f => f.month === identifier);
            } else {
                fee = currentStudentData.otherFees.find(f => f.name === identifier);
            }
            
            if (!fee || fee.status === 'Paid') return;

            const razorpayKey = 'rzp_live_bVX9625cESvXdO'; // <-- IMPORTANT: Updated with your key
            // Using a test key from Razorpay docs as a placeholder:
            // const razorpayKey = 'rzp_test_ILz2GxvU0T3tPY'; 
            
            if (razorpayKey === 'rzp_test_YOUR_KEY_HERE') {
                showToast("Payment system is not configured.", "error");
                console.error("Please add your Razorpay Key ID in index.html");
                return;
            }

            const options = {
                key: razorpayKey,
                amount: fee.amount * 100, // Amount in paise
                currency: "INR",
                name: "Rafi University",
                description: `Fee Payment for ${identifier}`,
                image: "https://placehold.co/100x100/006336/ffffff?text=RU",
                handler: (response) => {
                    console.log("Payment successful:", response);
                    updateFeeStatus(type, identifier, response.razorpay_payment_id);
                    showToast(`Payment for ${identifier} successful!`, 'success');
                },
                prefill: {
                    name: currentStudentData.name,
                    contact: currentStudentData.phone
                },
                notes: {
                    type: type,
                    identifier: identifier,
                    roll_number: currentStudentData.rollNumber,
                    student_id: currentStudentId
                },
                theme: { color: "#006336" },
                modal: {
                    ondismiss: () => {
                        console.log("Payment modal closed.");
                        showToast(`Payment for ${identifier} was cancelled.`, 'error');
                    }
                }
            };
            
            try {
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', (response) => {
                    console.error("Payment failed:", response);
                    showToast(`Payment failed: ${response.error.description}`, 'error', 5000);
                });
                rzp.open();
            } catch(e) {
                console.error("Error initiating Razorpay checkout:", e);
                showToast("Could not initiate payment.", "error");
            }
        }
        
        /**
         * Updates a fee's status after successful payment.
         */
        async function updateFeeStatus(type, identifier, paymentId) {
            if (!currentStudentId || !currentStudentData) return;
            
            const studentDocRef = doc(db, "students", currentStudentId);
            
            try {
                if (type === 'monthly') {
                    const newMonthlyFees = currentStudentData.monthlyFees.map(f => 
                        f.month === identifier ? { ...f, status: 'Paid', paymentId: paymentId } : f
                    );
                    await updateDoc(studentDocRef, { monthlyFees: newMonthlyFees });
                    
                } else if (type === 'other') {
                    const newOtherFees = currentStudentData.otherFees.map(f => 
                        f.name === identifier ? { ...f, status: 'Paid', paymentId: paymentId } : f
                    );
                    await updateDoc(studentDocRef, { otherFees: newOtherFees });
                }
                // The onSnapshot listener will automatically update the UI.
                
            } catch (error) {
                console.error("Error updating fee status:", error);
                showToast("Payment recorded, but failed to update status. Please contact support.", "error");
            }
        }

        /**
         * Shows a notification toast message.
         */
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = ``; // Clear existing classes
            toast.classList.add(type, 'show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
    </script>
</body>
</html>






